name: SmallRye Build

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.gitignore'
      - 'CODEOWNERS'
      - 'LICENSE'
      - 'NOTICE'
      - 'README*'
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    name: build

    steps:
      - uses: actions/checkout@v5
        name: checkout
        with:
          path: smallrye-parent

      - uses: actions/setup-java@v5
        name: set up jdk versions
        with:
          distribution: temurin
          architecture: x64
          java-version: |
            11
            17
            21
            25

      - name: Maven
        run: |
          cd smallrye-parent
          mvn -B -ntp formatter:validate install

      - uses: actions/checkout@v5
        name: checkout smallrye-config
        with:
          repository: smallrye/smallrye-config
          path: smallrye-config

      - name: test with smallrye-config
        run: |
          cd smallrye-config
          mvn -B -ntp versions:update-parent -DallowSnapshots=true -N
          git diff pom.xml
          mvn -B -ntp install -Djava11.home=${{env.JAVA_HOME_11_X64}} -Djava17.home=${{env.JAVA_HOME_17_X64}} -Djava21.home=${{env.JAVA_HOME_21_X64}}

      - uses: actions/checkout@v5
        name: checkout smallrye-common
        with:
          repository: smallrye/smallrye-common
          path: smallrye-common

      - name: test with smallrye-common
        run: |
          cd smallrye-common
          mvn -B -ntp versions:update-parent -DallowSnapshots=true -N
          git diff pom.xml
          mvn -B -ntp install -Djava11.home=${{env.JAVA_HOME_11_X64}} -Djava17.home=${{env.JAVA_HOME_17_X64}} -Djava21.home=${{env.JAVA_HOME_21_X64}}

      - uses: actions/checkout@v5
        name: checkout jandex
        with:
          repository: smallrye/jandex
          path: jandex

      - name: test with jandex
        run: |
          cd jandex
          mvn -B -ntp versions:update-parent -DallowSnapshots=true -N
          git diff pom.xml
          mvn -B -ntp install -Djava11.home=${{env.JAVA_HOME_11_X64}} -Djava17.home=${{env.JAVA_HOME_17_X64}} -Djava21.home=${{env.JAVA_HOME_21_X64}}

      - uses: actions/checkout@v5
        name: checkout smallrye-mutiny
        with:
          repository: smallrye/smallrye-mutiny
          path: smallrye-mutiny

      - name: test with smallrye-mutiny
        run: |
          cd smallrye-mutiny
          mvn -B -ntp versions:update-parent -DallowSnapshots=true -N
          git diff pom.xml
          mvn -B -ntp install -Djava11.home=${{env.JAVA_HOME_11_X64}} -Djava17.home=${{env.JAVA_HOME_17_X64}} -Djava21.home=${{env.JAVA_HOME_21_X64}}

      - uses: actions/checkout@v5
        name: checkout smallrye-stork
        with:
          repository: smallrye/smallrye-stork
          path: smallrye-stork

      - name: test with smallrye-stork
        run: |
          cd smallrye-stork
          # install the BOM first so update-parent does not fail
          mvn -B -ntp install -pl bom -DskipTests
          mvn -B -ntp versions:update-parent -DallowSnapshots=true -N
          git diff pom.xml
          JAVA_HOME="${{env.JAVA_HOME_21_X64}}" mvn -B -ntp install

      - uses: actions/checkout@v5
        name: checkout smallrye-reactive-messaging
        with:
          repository: smallrye/smallrye-reactive-messaging
          path: smallrye-reactive-messaging

      - name: test with smallrye-reactive-messaging
        run: |
          cd smallrye-reactive-messaging
          mvn -B -ntp versions:update-parent -DallowSnapshots=true -N
          git diff pom.xml
          mvn -B -ntp install -DskipTests
          # only test a subset because it takes a long time
          mvn -B -ntp install -pl api,smallrye-reactive-messaging-jms,smallrye-reactive-messaging-amqp -Djava11.home=${{env.JAVA_HOME_11_X64}} -Djava17.home=${{env.JAVA_HOME_17_X64}} -Djava21.home=${{env.JAVA_HOME_21_X64}}
